name: vprofile actions
on: workflow_dispatch
env: 
   AWS_REGION: us-east-1
   ECR_REPOSITORY: vpro-proj
   EKS_CLUSTER: vprofile-eks

jobs:
   Testing:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
        
        - name: Maven Test
          run: mvn test

        - name: Checkstyle
          run: mvn checkstyle:checkstyle
        
         #set up java 11 to be default
        - name: Set up JDK 11
          uses: actions/setup-java@v3
          with:
            java-version: '11'
            distribution: 'temurin'
        
        #set up sonar-scanner 
        - name: Setup SonarQube
          uses: warchant/sonar-scanner@v7

        #Run sonar-scanner
        - name: SonarQube Scan
          run: sonar-scanner
             - Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
             - Dsonar.login=${{ secrets.SONAR_TOKEN }}
             - Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
             - Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
             - Dsonar.sources=src/
             - Dsonar.junit.reportPath=target/surefire-reports/
             - Dsonar.jacoco.reportPath=target/jacoco.exec
             - Dsonar.java.checkstyle.reportPaths=target/checkstyle-result.xml
             - Dsonar.java.binaries=target/test-classes/com/visualpathit/account/controllerTest/

        # check the quality gate status
        - name: SonarQube Quality Gate Check
          id: sonarqube-quality-gate-check
          uses: sonarsource/sonarqube-quality-gate-action@master
             # Force fail step after specific time.
          timeout-minutes: 5  
          env:
            SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}